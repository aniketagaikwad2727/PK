<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard | Panchkalpa</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body>

    <!-- TOP NAVBAR -->
    <nav class="dashboard-navbar-container">
        <!-- 1. Logo -->
        <div class="dashboard-logo-wrapper">
            <img src="/static/assets/panchkalpa-logo-trans.png" alt="Panchkalpa">
        </div>

        <!-- 2. Navigation Links -->
        <div class="dashboard-nav-links-group">
            <a href="dashboard.html" class="dashboard-nav-item-button active"><i class="fa-brands fa-dashcube"></i> Dashboard</a>
            <a href="appointments.html" class="dashboard-nav-item-button"><i class="fa-solid fa-video"></i> Appointments</a>
            <a href="progress.html" class="dashboard-nav-item-button"><i class="fa-regular fa-calendar-check"></i> Progress</a>
            <a href="billing.html" class="dashboard-nav-item-button"><i class="fa-solid fa-file-invoice"></i> Billing</a>
                        <a href="teleconsult.html" class="dashboard-nav-item-button"><i class="fa-solid fa-headset"></i> Tele-Consult</a>

        </div>

        <!-- 3. Profile & Settings -->
        <div class="dashboard-nav-profile-section">
            
            <!-- Notifications (Bell) Wrapper -->
            <div class="notify-wrapper">
                <button class="dashboard-nav-item-button" style="background:none; border:none; cursor:pointer; padding: 10px;" onclick="toggleNotifyPopup()">
                    <i class="fa-solid fa-bell" style="font-size:1.2rem; color:var(--theme-gold);"></i>
                    <!-- Unread Badge -->
                    <span class="notify-badge-count" id="notify-badge" style="display:none;">0</span>
                </button>

                <!-- POPUP WINDOW -->
                <div class="notify-popup-window" id="notifyPopup">
                    <div class="notify-header-bar">
                        <h3 class="notify-header-title">Notifications</h3>
                        <button class="notify-action-link" onclick="markAllNotifyRead()">Mark all read</button>
                    </div>
                    <div class="notify-content-scroll-area" id="notify-content">
                        <div style="padding:20px; text-align:center; color:#999;">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- User Profile Pill -->
            <div class="dashboard-profile-summary-pill" onclick="window.location.href='profile.html'">
                <div class="dashboard-profile-icon-circle" id="header-initial">?</div>
                <div class="dashboard-profile-name-text" id="header-name">Loading...</div>
            </div>

            <!-- Logout -->
            <button class="dashboard-logout-action" title="Logout">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </nav>

    <!-- DASHBOARD CONTENT -->
    <div class="dashboard-main-container">
        
        <!-- Header -->
        <div class="dashboard-page-header">
            <div>
                <h1 class="dashboard-welcome-title">Welcome, <span id="welcome-name">...</span> ðŸ‘‹</h1>
                <div class="dashboard-current-date" id="current-date">Loading Date...</div>
            </div>
        </div>

        <!-- Grid -->
        <div class="dashboard-layout-grid" >

            <!-- Upcoming Appointment -->
            <div class="dashboard-content-card dashboard-col-span-4">
                <div class="dashboard-card-header-title">
                    <i class="far fa-calendar-check" style="color:var(--theme-gold-dark)"></i>
                    Upcoming Appointment
                </div>
                <div class="dashboard-appointment-widget">
                    <div class="dashboard-appointment-row">
                        <span class="dashboard-appointment-label">Therapy</span>
                        <span class="dashboard-appointment-value" id="appt-therapy">Loading...</span>
                    </div>
                    <div class="dashboard-appointment-row">
                        <span class="dashboard-appointment-label">Therapist</span>
                        <span class="dashboard-appointment-value" id="appt-therapist">Loading...</span>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem; font-weight:700; color:var(--theme-brown);" id="appt-date">--</div>
                        <div style="font-size:0.8rem; color:var(--theme-muted); text-transform:uppercase;" id="appt-month">--</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem; font-weight:700; color:var(--theme-brown);" id="appt-time">--:--</div>
                        <div style="font-size:0.8rem; color:var(--theme-muted); text-transform:uppercase;" id="appt-period">--</div>
                    </div>
                    <button style="background:var(--theme-brown); color:white; padding:8px 16px; border:none; border-radius:20px; cursor:pointer;">
                        Details <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Progress Chart -->
            <div class="dashboard-content-card dashboard-col-span-8">
                <div class="dashboard-card-header-title">
                    <i class="fas fa-chart-line" style="color:var(--theme-gold-dark)"></i>
                    Recovery Overview
                </div>
                <div class="dashboard-chart-wrapper">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-content-card dashboard-col-span-6">
                <div class="dashboard-card-header-title">
                    <i class="fas fa-bolt" style="color:var(--theme-gold-dark)"></i>
                    Quick Actions
                </div>
                <div class="dashboard-action-grid">
                    <a href="#" class="dashboard-action-button">
                        <i class="far fa-calendar-plus"></i>
                        <span>Book Appointment</span>
                    </a>
                    <a href="#" class="dashboard-action-button">
                        <i class="fas fa-tasks"></i>
                        <span>View Progress</span>
                    </a>
                    <a href="#" class="dashboard-action-button">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Pay Bills</span>
                    </a>
                    <a href="#" class="dashboard-action-button">
                        <i class="fas fa-video"></i>
                        <span>Online Consultation</span>
                    </a>
                </div>
            </div>

            <!-- Recent Notes -->
            <div class="dashboard-content-card dashboard-col-span-6">
                <div class="dashboard-card-header-title">
                    <i class="fas fa-notes-medical" style="color:var(--theme-gold-dark)"></i>
                    Recent Session Notes
                </div>
                
                <div id="recent-notes-container">
                    <!-- Content injected via JS -->
                    <p class="muted" style="text-align:center;">Loading notes...</p>
                </div>

                <div style="margin-top:auto; text-align:right; padding-top:10px;">
                    <a href="#" style="color:var(--theme-brown); font-weight:700; font-size:0.9rem; text-decoration:none;">View All History â†’</a>
                </div>
            </div>

        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            
            /* =========================================
               1. DASHBOARD CONTENT LOGIC
               ========================================= */
            
            const MOCK_DATA = {
                user: { firstName: "Aniket", lastName: "Sharma", role: "Patient" },
                appointment: { therapy: "Shirodhara", therapist: "Dr. Ananya Vaidya", date: "22", month: "Nov", time: "10:00", period: "AM" },
                progress: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'], data: [45, 50, 62, 68, 75, 82] },
                notes: [
                    { day: "18", month: "NOV", title: "Abhyanga Session", preview: "Patient responded well to oil application. Stiffness in lower back reduced..." },
                    { day: "12", month: "NOV", title: "Nasya Karma", preview: "Sinus congestion cleared significantly. Advised light diet for dinner." }
                ]
            };

            async function initDashboard() {
                let data = MOCK_DATA;
                try {
                    const response = await fetch('/api/dashboard-data/');
                    if (response.ok) {
                        const jsonData = await response.json();
                        if(jsonData.user) data = jsonData; 
                    }
                } catch (error) { console.error("Network error. Using mock data."); }
                renderDashboard(data);
            }

            function renderDashboard(data) {
                document.getElementById('welcome-name').textContent = data.user.firstName;
                document.getElementById('header-name').textContent = data.user.firstName;
                document.getElementById('header-initial').textContent = data.user.firstName.charAt(0);
                
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
                document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', dateOptions);

                if (data.appointment) {
                    document.getElementById('appt-therapy').textContent = data.appointment.therapy;
                    document.getElementById('appt-therapist').textContent = data.appointment.therapist;
                    document.getElementById('appt-date').textContent = data.appointment.date;
                    document.getElementById('appt-month').textContent = data.appointment.month;
                    document.getElementById('appt-time').textContent = data.appointment.time;
                    document.getElementById('appt-period').textContent = data.appointment.period;
                }

                const notesContainer = document.getElementById('recent-notes-container');
                notesContainer.innerHTML = '';
                if (data.notes && data.notes.length > 0) {
                    data.notes.forEach(note => {
                        const html = `
                        <div class="dashboard-note-item">
                            <div class="dashboard-note-date-box">
                                <span class="dashboard-note-date-month">${note.month}</span>
                                <strong class="dashboard-note-date-day">${note.day}</strong>
                            </div>
                            <div class="dashboard-note-content">
                                <h5>${note.title}</h5>
                                <p>${note.preview}</p>
                                <a href="#" class="dashboard-note-link">Read full note</a>
                            </div>
                        </div>`;
                        notesContainer.innerHTML += html;
                    });
                } else {
                    notesContainer.innerHTML = '<p class="muted" style="text-align:center; padding:10px;">No recent notes found.</p>';
                }
                initChart(data.progress);
            }

            function initChart(progressData) {
                const ctx = document.getElementById('progressChart').getContext('2d');
                let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(255, 215, 0, 0.5)'); 
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: progressData.labels,
                        datasets: [{
                            label: 'Vitality Score',
                            data: progressData.data,
                            borderColor: '#78350f',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointBackgroundColor: '#FFD700',
                            pointBorderColor: '#78350f',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [5, 5], color: '#e0e0e0' } }, x: { grid: { display: false } } }
                    }
                });
            }

            initDashboard();
        });

        /* =========================================
           2. NOTIFICATION POPUP LOGIC (Global)
           ========================================= */
        let isNotifyOpen = false;

        function toggleNotifyPopup() {
            const popup = document.getElementById('notifyPopup');
            isNotifyOpen = !isNotifyOpen;
            if (isNotifyOpen) {
                popup.classList.add('notify-is-visible');
                fetchNotifyData();
            } else {
                popup.classList.remove('notify-is-visible');
            }
        }

        // Close on click outside
        document.addEventListener('click', function(event) {
            const wrapper = document.querySelector('.notify-wrapper');
            if (wrapper && !wrapper.contains(event.target)) {
                document.getElementById('notifyPopup').classList.remove('notify-is-visible');
                isNotifyOpen = false;
            }
        });

        function fetchNotifyData() {
            // Mock Notification Data
            const mockNotifs = [
                { id: 1, type: 'session', title: "Upcoming Session", message: "Shirodhara starts in 2 hours.", time: "10 mins ago", isRead: false, link: "#" },
                { id: 2, type: 'alert', title: "Symptom Alert", message: "Please check post-care instructions.", time: "1 hour ago", isRead: false, link: "#" },
                { id: 3, type: 'precaution', title: "Hydration", message: "Drink warm water before your session.", time: "2 hours ago", isRead: true, link: "#" }
            ];

            // Simulate fetch
            // In real app: fetch('/api/notifications/').then(res => res.json())...
            renderNotifyPopup(mockNotifs);
        }

        function renderNotifyPopup(data) {
            const container = document.getElementById('notify-content');
            const badge = document.getElementById('notify-badge');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div style="padding:30px; text-align:center; color:#ccc; font-style:italic;">No notifications</div>';
                badge.style.display = 'none';
                return;
            }

            const unreadCount = data.filter(n => !n.isRead).length;
            if(unreadCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                badge.style.display = 'none';
            }

            data.forEach(item => {
                let iconClass = 'fa-bell';
                let typeClass = 'notify-color-msg';
                
                if(item.type === 'session') { iconClass = 'fa-calendar-check'; typeClass = 'notify-color-session'; }
                else if(item.type === 'alert') { iconClass = 'fa-exclamation-triangle'; typeClass = 'notify-color-alert'; }
                else if(item.type === 'precaution') { iconClass = 'fa-glass-water'; typeClass = 'notify-color-precaution'; }

                const html = `
                <div class="notify-list-item ${item.isRead ? '' : 'notify-state-unread'}">
                    <div class="notify-type-icon ${typeClass}">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="notify-item-text">
                        <h4>${item.title}</h4>
                        <p>${item.message}</p>
                        <span class="notify-timestamp">${item.time}</span>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function markAllNotifyRead() {
            alert("All marked as read (Mock Action)");
            document.getElementById('notify-badge').style.display = 'none';
            const items = document.querySelectorAll('.notify-list-item');
            items.forEach(i => i.classList.remove('notify-state-unread'));
        }
    </script>

</body>
</html>