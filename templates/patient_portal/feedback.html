<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback & Symptoms | Panchkalpa</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. Color Palette --- */
        :root {
            --gold: #FFD700; --gold-dark: #C8A300; --cream: #FFF8E6; --brown: #78350f;
            --bg-light: #fff7e5; --text-dark: #2A241F; --muted: #6b5f5a; --white: #ffffff;
            --shadow: 0 4px 15px rgba(120, 53, 15, 0.08); --radius: 12px;
            --alert-red: #c62828;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-light); color: var(--text-dark); font-family: 'Lato', sans-serif; padding: 20px; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--brown); }

        /* --- 2. Namespaced Styles: feedback-* --- */

        .feedback-container { max-width: 1200px; margin: 0 auto; }

        .feedback-header {
            margin-bottom: 25px; border-bottom: 2px solid rgba(120, 53, 15, 0.1); padding-bottom: 15px;
        }

        .feedback-grid {
            display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px;
        }

        /* Card Components */
        .feedback-card {
            background: var(--white); border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow); margin-bottom: 25px;
        }
        .feedback-card-title {
            font-size: 1.2rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
            color: var(--brown); font-weight: 700; border-bottom: 1px dashed #eee; padding-bottom: 10px;
        }

        /* A. Symptom Sliders */
        .feedback-slider-group { margin-bottom: 20px; }
        
        .feedback-label-row {
            display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 700;
        }
        .feedback-val-display {
            background: var(--brown); color: var(--gold); padding: 2px 8px;
            border-radius: 4px; font-size: 0.8rem; min-width: 30px; text-align: center;
        }

        /* Custom Range Input Styling */
        .feedback-range {
            width: 100%; -webkit-appearance: none; height: 6px; border-radius: 5px;
            background: #ddd; outline: none; opacity: 0.8; transition: opacity .2s;
        }
        .feedback-range::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: var(--gold); border: 2px solid var(--brown); cursor: pointer;
        }
        .feedback-range::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%; background: var(--gold); border: 2px solid var(--brown); cursor: pointer;
        }

        /* High severity warning */
        .feedback-warning-text {
            color: var(--alert-red); font-size: 0.8rem; margin-top: 5px; display: none; font-weight: bold;
        }
        .feedback-range.high-alert + .feedback-warning-text { display: block; }


        /* B. Session Feedback Form */
        .feedback-star-rating {
            display: flex; gap: 10px; font-size: 1.5rem; color: #ccc; margin-bottom: 15px; cursor: pointer;
        }
        .feedback-star-rating i.active { color: var(--gold); }
        
        .feedback-textarea {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px;
            font-family: 'Lato', sans-serif; margin-bottom: 15px; resize: vertical;
            background: var(--bg-light);
        }
        .feedback-textarea:focus { border-color: var(--gold); outline: none; }

        /* C. History & Suggestions */
        .feedback-suggestion-item {
            background: var(--cream); border-left: 4px solid var(--gold-dark);
            padding: 12px; margin-bottom: 10px; font-size: 0.9rem;
        }
        
        .feedback-submit-btn {
            width: 100%; padding: 15px; background: var(--brown); color: var(--white);
            border: none; border-radius: 8px; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: background 0.3s; display: flex; justify-content: center; gap: 10px;
        }
        .feedback-submit-btn:hover { background: #5a270b; }

        @media (max-width: 768px) { .feedback-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="feedback-container">
    <header class="feedback-header">
        <h1>Symptom Tracker & Feedback</h1>
        <span style="color: var(--muted);">Your inputs tailor your recovery plan.</span>
    </header>

    <div class="feedback-grid">
        
        <div class="feedback-left-col">
            
            <section class="feedback-card">
                <div class="feedback-card-title"><i class="fas fa-sliders-h"></i> Daily Check-in (0-5)</div>
                <form id="symptom-form">
                    
                    <div class="feedback-slider-group">
                        <div class="feedback-label-row">
                            <span><i class="fas fa-battery-quarter"></i> Fatigue</span>
                            <span class="feedback-val-display" id="val-fatigue">0</span>
                        </div>
                        <input type="range" min="0" max="5" value="0" class="feedback-range" id="input-fatigue" oninput="updateSlider('fatigue')">
                    </div>

                    <div class="feedback-slider-group">
                        <div class="feedback-label-row">
                            <span><i class="fas fa-brain"></i> Headache</span>
                            <span class="feedback-val-display" id="val-headache">0</span>
                        </div>
                        <input type="range" min="0" max="5" value="0" class="feedback-range" id="input-headache" oninput="updateSlider('headache')">
                        <div class="feedback-warning-text" id="warn-headache">Alert: High severity. Practitioner will be notified.</div>
                    </div>

                    <div class="feedback-slider-group">
                        <div class="feedback-label-row">
                            <span><i class="fas fa-meh-rolling-eyes"></i> Nausea</span>
                            <span class="feedback-val-display" id="val-nausea">0</span>
                        </div>
                        <input type="range" min="0" max="5" value="0" class="feedback-range" id="input-nausea" oninput="updateSlider('nausea')">
                    </div>

                    <div class="feedback-slider-group">
                        <div class="feedback-label-row">
                            <span><i class="fas fa-bed"></i> Sleep Quality (5 = Best)</span>
                            <span class="feedback-val-display" id="val-sleep">3</span>
                        </div>
                        <input type="range" min="0" max="5" value="3" class="feedback-range" id="input-sleep" oninput="updateSlider('sleep')">
                    </div>

                </form>
            </section>

            <section class="feedback-card">
                <div class="feedback-card-title"><i class="fas fa-comment-medical"></i> Recent Session Feedback</div>
                <p style="color:var(--muted); margin-bottom:10px; font-size:0.9rem;">For: <strong id="last-session-name">Loading...</strong></p>
                
                <div class="feedback-star-rating" id="star-rating">
                    <i class="fas fa-star" data-val="1" onclick="setRating(1)"></i>
                    <i class="fas fa-star" data-val="2" onclick="setRating(2)"></i>
                    <i class="fas fa-star" data-val="3" onclick="setRating(3)"></i>
                    <i class="fas fa-star" data-val="4" onclick="setRating(4)"></i>
                    <i class="fas fa-star" data-val="5" onclick="setRating(5)"></i>
                </div>

                <textarea class="feedback-textarea" rows="3" placeholder="What improved? Any discomfort?"></textarea>
                <textarea class="feedback-textarea" rows="2" placeholder="Side effects observed?"></textarea>

                <button class="feedback-submit-btn" onclick="submitFeedback()">
                    Submit Daily Report <i class="fas fa-paper-plane"></i>
                </button>
            </section>

        </div>

        <div class="feedback-right-col">
            
            <section class="feedback-card">
                <div class="feedback-card-title"><i class="fas fa-chart-area"></i> Symptom Trends</div>
                <canvas id="symptomChart"></canvas>
            </section>

            <section class="feedback-card">
                <div class="feedback-card-title"><i class="fas fa-user-md"></i> Doctor's Suggestions</div>
                <div id="suggestions-container">
                    <div style="color:var(--muted);">Loading suggestions...</div>
                </div>
            </section>

            <button style="background:transparent; border:1px solid var(--brown); width:100%; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold; color:var(--brown);">
                View Full History
            </button>
        </div>

    </div>
</div>

<script>
    let currentRating = 0;

    // 1. Initialize Page
    document.addEventListener('DOMContentLoaded', () => {
        fetchFeedbackData();
    });

    // 2. Slider Logic (Visual update only)
    function updateSlider(id) {
        const input = document.getElementById('input-' + id);
        const display = document.getElementById('val-' + id);
        const warning = document.getElementById('warn-' + id);
        
        display.textContent = input.value;

        // Alert logic for severity > 4
        if(input.value >= 4 && id !== 'sleep') { // Sleep 5 is good, ignore
            if(warning) warning.style.display = 'block';
            display.style.backgroundColor = 'var(--alert-red)';
        } else {
            if(warning) warning.style.display = 'none';
            display.style.backgroundColor = 'var(--brown)';
        }
    }

    // 3. Star Rating Logic
    function setRating(val) {
        currentRating = val;
        const stars = document.querySelectorAll('.feedback-star-rating i');
        stars.forEach(star => {
            if(star.dataset.val <= val) star.classList.add('active');
            else star.classList.remove('active');
        });
    }

    // 4. Fetch Data (Mock API)
// Variable to hold the chart instance so we can destroy it before updates
    let myChartInstance = null;

    function fetchFeedbackData() {
        // Call the Django View: feedback_data_api
        fetch('/api/feedback-data/') 
            .then(response => {
                if (!response.ok) throw new Error("Failed to load feedback data");
                return response.json();
            })
            .then(data => {
                renderFeedbackPage(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('suggestions-container').innerHTML = 
                    '<div style="color:red;">Unable to load data. Check connection.</div>';
            });
    }

    function renderFeedbackPage(data) {
        // 1. Update "Recent Session" Text
        const sessionLabel = document.getElementById('last-session-name');
        if(data.lastSession) {
            sessionLabel.textContent = data.lastSession;
        } else {
            sessionLabel.textContent = "No recent completed sessions";
        }

        // 2. Populate Doctor's Suggestions
        const suggContainer = document.getElementById('suggestions-container');
        suggContainer.innerHTML = ''; // Clear loading text
        
        if (data.suggestions && data.suggestions.length > 0) {
            data.suggestions.forEach(txt => {
                suggContainer.innerHTML += `<div class="feedback-suggestion-item">${txt}</div>`;
            });
        } else {
            suggContainer.innerHTML = `<div style="color:var(--muted); font-style:italic;">No new suggestions.</div>`;
        }

        // 3. Render/Update Chart.js
        const ctx = document.getElementById('symptomChart').getContext('2d');
        
        // Destroy previous chart instance if it exists (prevents glitching)
        if (myChartInstance) {
            myChartInstance.destroy();
        }

        myChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.history.dates, // e.g., ["Mon", "Tue", "Wed"]
                datasets: [
                    {
                        label: 'Headache',
                        data: data.history.headache,
                        borderColor: '#c62828', // Red
                        backgroundColor: 'rgba(198, 40, 40, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Fatigue',
                        data: data.history.fatigue,
                        borderColor: '#FFD700', // Gold
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }

    // 5. Submit Logic
    function submitFeedback() {
        // Gather data
        const payload = {
            fatigue: document.getElementById('input-fatigue').value,
            headache: document.getElementById('input-headache').value,
            nausea: document.getElementById('input-nausea').value,
            rating: currentRating,
            notes: document.querySelector('.feedback-textarea').value
        };

        console.log("Submitting:", payload);
        alert("Feedback Submitted! Your recovery score will update shortly.");
        
        // fetch('/api/submit-feedback/', { method: 'POST', body: JSON.stringify(payload)... })
    }
</script>

</body>
</html>